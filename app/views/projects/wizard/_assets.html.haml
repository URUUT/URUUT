.step-container{"data-id" => "assets"}
  = form_for(@project, :html => {:multipart => true }) do |f|
    = hidden_field_tag "step", "last"
    - if !@project.large_image.blank?
      #large_image{:style => "background-image: url(#{@project.large_image}); -webkit-background-size: cover; background-size: cover;", data: {image: 'true'}}
        .div{style: "height: 546px;", id: "image-priview"}
          %input{:type => 'filepicker', :name => 'large_image', 'data-fp-button-text' => 'Choose A Cover Photo', 'data-fp-apikey' => 'ArmO0TLVTkyCaJkQmBNfqz', 'data-fp-button-class' => 'coverphoto btn', 'onchange' => 'updateCover(event)', :style => 'left:50%'}
          = render "funding_info"
    - else
      #large_image{data: {image: 'false'}}
        .div{style: "height: 546px;", id: "image-priview"}
          %input{:type => 'filepicker', :name => 'large_image', 'data-fp-button-text' => 'Choose A Cover Photo', 'data-fp-apikey' => 'ArmO0TLVTkyCaJkQmBNfqz', 'data-fp-button-class' => 'coverphoto btn pick-cover-photo', 'onchange' => 'updateCover(event)', :style => 'left:50%'}

        = render "funding_info"

    .span12.action-convert{style: "margin-top: 484px; display:none"}
      = hidden_field_tag "url_image"
      = hidden_field_tag "x_position"
      = hidden_field_tag "y_position"
      = hidden_field_tag "width_after"
      = hidden_field_tag "height_after"
      .action.pull-right
        %a.btn.change-image{href: "javascript:void(0)"} Change cover photo
        %a.btn.save-image{href: "javascript:void(0)"} Save Images

    .show-content.clearfix
      .span8
        %h4.title Where We're Ruuted
        .map-container
          #map{:style => "width:100%;height:300px"}
          #map-details
            .project-location
              %h4= @project.title
              %div{:style => 'font-family:"Proxima Nova"'}
                = image_tag "marker.jpg", :class => 'marker', :style => 'float:none;'
                = @project.address
                = @project.city
                = @project.state
                = @project.zip
              %div
                %span.label-green{:style => "margin-left: 10px;"}
                  WEB:
                  - unless @project.website.nil?
                    = link_to(strip_url(@project.website), recognize_url(@project.website), target: "_blank", :style => "font-style: italic; text-decoration: underline; color: #3f403b; font-family: 'Georgia', serif;")
        - if @project.sponsor_permission
          %h4.title{:style => 'margin-top:50px;'} PROJECT SPONSORS
          = link_to "javascript:void(0)", :class => 'btn', :style => 'background:#3f403b;padding:10px;margin-top:10px;' do
            Become A Sponsor
            %span

        %h4.title{:style => 'margin-top:50px;'}
          Planting Seeds
          %span (About)

        #content_container
          #planting_seeds
            .media-container
              - if @project.seed_mime_type.eql?("video") and !@project.seed_video.blank?
                - video_seed = @project.seed_video.gsub("watch?v=", "embed/")
                .seed-content
                  %iframe{:height => "413", :src => video_seed, :width => "620"}
              - elsif @project.seed_mime_type.eql?("image") and !@project.seed_image.blank?
                .seed-content.clearfix
                  = image_tag "#{@project.seed_image}", style: "float:left; width:100%"
              - else
                %div.seed-content.clearfix{:style => "background: #C4B8B8; width: 100%; height: 414px"}
                  .seed-action-container
                    %div.pull-left
                      %input{:type => 'filepicker', :name => 'planting_seed_image', 'data-fp-button-text' => 'Add a Photo', 'data-fp-apikey' => 'ArmO0TLVTkyCaJkQmBNfqz', 'data-fp-button-class' => 'btn', 'onchange' => 'updatePlantingSeedImage(event)'}
                    %div.pull-left
                      = link_to '<i class="icon-facetime-video icon-green"></i> Upload New Video'.html_safe, "javascript:void(0)", class: "btn seed-form"


              .seed-action-container{style: action_image(@project.seed_image, @project.seed_video)}
                %input{:type => 'filepicker', :name => 'planting_seed_image', 'data-fp-button-text' => 'Upload New Photo', 'data-fp-apikey' => 'ArmO0TLVTkyCaJkQmBNfqz', 'data-fp-button-class' => 'btn', 'onchange' => 'updatePlantingSeedImage(event)'}
                = link_to '<i class="icon-facetime-video icon-green"></i> Upload New Video'.html_safe, "javascript:void(0)", class: "btn seed-form"

            %div{:style => "font:normal 14px/24px 'Proxima Nova', arial, sans-serif;margin-top:10px;word-wrap: break-word;"}= @project.story

          %hr

          #cultivation
            .span2.ending
              %h4.title
                CULTIVATION
                %br
                %span (Project Details)

                %h6{:style => "text-align:center;color:#55554d !important;font-family:'Proxima Nova';margin-top:15px;"} Funding Ends
                %div{:style => "background:#b6b6b4;padding:25px;border-radius:500px;"}
                  %span{:style => 'display:block;text-align:center;font:normal 22px/22px "Proxima Nova Semi";color:#fff;text-transform:uppercase;letter-spacing:5px;'}= (Date.today + (@project.duration).to_i.days).strftime("%b")
                  %span{:style => 'display:block;text-align:center;font:normal 72px/72px "Proxima Nova Semi";color:#fff;text-transform:uppercase;margin-top:5px'}= (Date.today + (@project.duration).to_i.days).strftime("%d")
                %h6{:style => "text-align:center;color:#55554d !important;font-family:'Proxima Nova';margin-top:40px;margin-bottom:0;"} Project Goal
                %h2{:style => "text-align:center;color:#b6b6b4;font-family:'Proxima Nova Semi';margin-top:0;"}= number_to_currency(@project.goal, :precision => 0)

            .span5.details{:style => "width: 400px"}
              .cultivation-image-priview
                - if @project.cultivation_mime_type.eql?("video") and !@project.cultivation_video.blank?
                  - cultivation_video = @project.cultivation_video.gsub("watch?v=", "embed/")
                  .cultivation-content.clearfix
                    %iframe{:height => "310", :src => cultivation_video, :width => "380"}
                - elsif @project.cultivation_mime_type.eql?("image") and !@project.cultivation_image.blank?
                  .cultivation-content.clearfix
                    = image_tag "#{@project.cultivation_image}", style: "float:left; width:100%"
                - else
                  %div.cultivation-content.clearfix{:style => "background: #C4B8B8; width: 100%; height: 310px"}
                    .cultivation-action-container
                      %div.pull-left
                        %input{:type => 'filepicker', :name => 'cultivation_image', 'data-fp-button-text' => 'Add a Photo', 'data-fp-apikey' => 'ArmO0TLVTkyCaJkQmBNfqz', 'data-fp-button-class' => 'btn', 'onchange' => 'updateCultivationImage(event)'}
                      %div.pull-left
                        = link_to '<i class="icon-facetime-video icon-green"></i> Upload New Video'.html_safe, "javascript:void(0)", class: "btn cultivation-form"

                .cultivation-action-container.clearfix{style: action_image(@project.cultivation_image, @project.cultivation_video)}
                  %input{:type => 'filepicker', :name => 'cultivation_image', 'data-fp-button-text' => 'Upload New Photo', 'data-fp-apikey' => 'ArmO0TLVTkyCaJkQmBNfqz', 'data-fp-button-class' => 'btn', 'onchange' => 'updateCultivationImage(event)'}
                  = link_to '<i class="icon-facetime-video icon-green"></i> Upload New Video'.html_safe, "javascript:void(0)", class: "btn cultivation-form"

              %div{:style => "font:normal 14px/24px 'Proxima Nova', arial, sans-serif;margin-top:10px;word-wrap: break-word;"}= @project.about

      .span4.sidebar
        - if @project.sponsor_permission
          %h4 BECOME A SPONSOR
          .well
            %h3{:style => "font-size:20px;letter-spacing:normal;color:#70bf4c;line-height:100%;margin:0;font-family:'Proxima Nova';"} PROJECT SPONSORSHIP
            %p{:style => "font:normal 12px/18px 'Proxima Nova', arial, sans-serif;color:#403e37;margin-bottom:40px;"} We canâ€™t do this alone. Do your part, by becoming a project sponsor. URUUT Partner-Funding depends on individual contributors as well as project sponsorship from businesses and corporate and family foundations. Click the button below to get more details and become a project sponsor.
            = link_to "javascript:void(0)", :class => 'black-btn btn', :style => 'margin-top:10px;' do
              Become A Sponsor
              %span

          / %h4.title{:style => 'margin-top:50px;'} Seeder Perks
          / %ul.perks
          /   -if @perks
          /     - @perks.each do |p|
          /       %li.perk
          /         %h3= p.name
          /         %p.description= p.description
          /         %ul
          /           %li
          /             %h6 SEED
          /             %p.amount $#{p.amount.to_i}
          /           %li.fund-button
          /             %a{:href => "#assets", :class => "fund btn"} Fund Now #{image_tag('arrow.png')}

          %ul#myTab4.tab-nav
            %li.active
              %a{:href => "#perks"} Donate
            %li
              %a{:href => "#sponsorship"} Sponsor
          .tab-content
            #perks.tab-pane.active
              -if @project.perk_permission
                -if @perks
                  - @perks.each do |p|
                    .seed-level
                      %h3{style: "font-size: 20px;"}
                        = p.name
                      - if p.limit
                        %p= p.perks_available.to_i.zero? ? "(No Perks Remaining)" : "(#{p.perks_available} Available)"
                      %p.description= p.description
                      .clearfix
                        .seed-num
                          .amount
                            %p.amount $#{p.amount.to_i}
                        %a.black-btn.btn.pull-right{:href => "javascript:void(0)"} Fund Now #{image_tag('arrow.png')}
              -else
                - default_perk.each_with_index do |perk, index|
                  - index += 1
                  - name = "LEVEL #{index}"
                  - description = "You will receive #{perk} Uruut Reward Points when you seed $#{perk}"
                  .seed-level
                    %h3= name
                    %p{style: "height: auto; margin: 5px 0; overflow: hidden; text-overflow:ellipsis;"}= description
                    .clearfix
                      .seed-num
                        .amount
                          %p.amount $#{perk}
                      %a.black-btn.btn.pull-right{:href => "javascript:void(0)"} Fund Now #{image_tag('arrow.png')}

              .seed-level{id: "perk-id-custom"}
                %h3.perk-name-other{id: "perk-name-other-custom"}
                  CHOOSE YOUR PERK
                %p With this option you choose the amount to seed, you will receive 1 Uruut Reward Point for each dollar you seed.
                .clearfix
                  .seed-num
                    .amount
                    %h5 AMOUNT TO SEED
                    .textarea.seed-amount= text_field_tag :custom_seed, nil, style: "width: 100%"
                  %a.black-btn.btn.pull-right{:class => "fund btn", "perk-id" => "custom", id: "button-seed-custom"} Fund Now

            #sponsorship.tab-pane
              .seed-level
                %h3
                  PLATINUM
                  %span.small-heading
                    (1 of 1 available)
                %ul.normal-font.dashed-list
                  -if @sponsorship_benefits.include?(1)
                    -@sponsorship_benefits[1].each do |benefit|
                      %li= benefit.name
                .clearfix
                  .seed-num
                    .amount
                      = number_to_currency(@project.goal.to_i * 0.3)
                  %a.black-btn.btn.pull-right{:href => "javascript:void(0)"}
                    Sponsor
                    %span
              .seed-level
                %h3
                  GOLD
                  %span.small-heading
                    (3 of 3 available)
                %ul.normal-font.dashed-list
                  -if @sponsorship_benefits.include?(2)
                    -@sponsorship_benefits[2].each do |benefit|
                      %li= benefit.name
                .clearfix
                  .seed-num
                    .amount
                      = number_to_currency(@project.goal.to_i * 0.1)
                  %a.black-btn.btn.pull-right{:href => "javascript:void(0)"}
                    Sponsor
                    %span
              .seed-level
                %h3
                  SILVER
                  %span.small-heading
                    (5 of 5 available)
                %ul.normal-font.dashed-list
                  -if @sponsorship_benefits.include?(3)
                    -@sponsorship_benefits[3].each do |benefit|
                      %li= benefit.name
                      %span
                .clearfix
                  .seed-num
                    .amount
                      = number_to_currency(@project.goal.to_i * 0.04)
                  %a.black-btn.btn.pull-right{:href => "javascript:void(0)"}
                    Sponsor
                    %span
              .seed-level
                %h3 BRONZE
                %ul.normal-font.dashed-list
                  -if @sponsorship_benefits.include?(4)
                    -@sponsorship_benefits[4].each do |benefit|
                      %li= benefit.name
                .clearfix
                  .seed-num
                    .amount
                      - if (@project.goal.to_i * 0.1) >= 500
                        = number_to_currency(500)
                      - else
                        = number_to_currency(@project.goal.to_i * 0.1)
                  %a.black-btn.btn.pull-right{:href => "javascript:void(0)"}
                    Sponsor
                    %span
        - else
          %h4.tittle{style: "margin-bottom: 0;"} Donation
          -if @project.perk_permission
            -if @perks
              - @perks.each do |p|
                .seed-level
                  %h3{style: "font-size: 20px;"}
                    = p.name
                  - if p.limit
                    %p= p.perks_available.to_i.zero? ? "(No Perks Remaining)" : "(#{p.perks_available} Available)"
                  %p.description= p.description
                  .clearfix
                    .seed-num
                      .amount
                        %p.amount
                          = number_to_currency(p.amount.to_i, precision: 0)
                    %a.black-btn.btn.pull-right{:href => "javascript:void(0)"} Fund Now #{image_tag('arrow.png')}
          -else
            - default_perk.each_with_index do |perk, index|
              - index += 1
              - name = "LEVEL #{index}"
              - description = "You will receive #{perk} Uruut Reward Points when you seed $#{perk}"
              .seed-level
                %h3= name
                %p{style: "height: auto; margin: 5px 0; overflow: hidden; text-overflow:ellipsis;"}= description
                .clearfix
                  .seed-num
                    .amount
                      %p.amount
                        = number_to_currency(perk, precision: 0)
                  %a.black-btn.btn.pull-right{:href => "javascript:void(0)"} Fund Now #{image_tag('arrow.png')}

          .seed-level{id: "perk-id-custom"}
            %h3.perk-name-other{id: "perk-name-other-custom"}
              CHOOSE YOUR PERK
            %p With this option you choose the amount to seed, you will receive 1 Uruut Reward Point for each dollar you seed.
            .clearfix
              .seed-num
                .amount
                %h5 AMOUNT TO SEED
                .textarea.seed-amount= text_field_tag :custom_seed, nil, style: "width: 100%"
              %a.black-btn.btn.pull-right{:class => "fund btn", "perk-id" => "custom", id: "button-seed-custom"} Fund Now

        %h4.title{:style => 'margin-top:50px;'}
          Planter
          %span (Project Organizer)
        .planter
          -if current_user.avatar.blank?
            = image_tag(get_gravatar(current_user.email, 100), :style => "display:inline-block;margin-right:20px;width:100px;height:100px;")
          -else
            = image_tag current_user.avatar, :style => "display:inline-block;margin-right:20px;width:100px;height:100px;"
          %h4{:style => "color:#70bf4c;letter-spacing:2px;"}= @project.organization

        - if @project.sponsor_permission
          %h4.title{:style => 'margin-top:50px;'} Project Sponsors
          = link_to "javascript:void(0)", :class => 'black-btn btn', :style => 'margin-top:10px;' do
            Become A Sponsor
            %span

        %h4.title{:style => 'margin-top:50px;'}
          Seeders (0)
          %span (Project Funders)

    .span12
      %hr{:style => "background: #e0e0e0; margin-top: 0;"}
      %div{:style => "margin-bottom: 40px; text-align: center;"}
        %a.btn.submit-finish-project{:href => "submit", :style =>"text-align: left; border-radius: 5px;"}
          %h5{:style => "margin-bottom: 0"}
            Submission
          %h2{:style => "color: #fff; margin: 0; font-size: 24px; line-height: 30px;"}
            Get Ruuted
            %span
          %p{:style => "font: 400 italic 11px/15px 'Georgia', serif; color: #464646; text-transform: initial"} Submit Your Project for Approval

#save-video.modal.hide.fade
  .modal-header
    %button.close{"aria-hidden" => "true", "data-dismiss" => "modal", :type => "button"} Ã—
    %h3.title-form-video
  = form_tag save_video_projects_path, method: :post do
    .modal-body
      = url_field_tag "video_link", nil, placeholder: "youtube_url"
      = hidden_field_tag "video_type"
    .modal-footer
      %input{:type => "submit", :value => "Submit video", onClick: "$(this).button('loading')"}

:javascript

  $('.tax-deductible').tooltip({
      placement: "top",
      trigger: "hover"
    });

= javascript_include_tag "//code.jquery.com/ui/1.10.3/jquery-ui.js"
= javascript_include_tag "jquery.ui.touch-punch.min"

:javascript

  var updateCover = function(event){
    console.log(event.fpfile.url);
    var largeImage = event.fpfile.url,
    current_bg = $('#large_image').css('background-image');
    console.log("finished");
    $("body").animate({ scrollTop: 0 }, "slow");
    $('<img />').attr('src', largeImage).load(function() {
      var largeImageObj = new Image;
      largeImageObj.src = largeImage;
      console.log(largeImageObj.width);
      if ( largeImageObj.width >= 1600 )
      {
        $.ajax({
          url: '/projects/save_image',
          method: 'POST',
          data: { large_image: largeImage }
        });
        $(".coverphoto").hide();
        $(".div-image-priview").remove();
        $("#url_image").val(largeImage);
        $("#image-priview").hide();

        $(".funding-info").hide();

        var dragImg = new Image;
        dragImg.src = largeImage;
        dragImg.id = "dragImg"

        $('.ui-draggable').remove();
        $('#large_image').append(dragImg);
        $('#large_image').append('<span class="drag-instructions">Drag to Reposition</span>');

        $('#dragImg').draggable({
          axis: 'y',
          drag: function(event, ui) {
            var bottom = $(this).parent().height() - $(this).height();
            if(ui.position.top > 0) {
              ui.position.top = 0;
            }

            if(ui.position.top < bottom) {
              ui.position.top = bottom;
            }
          },
          stop: function(event, ui) {
            var w = $('.ui-draggable').width();
            var wOriginal = largeImageObj.width;
            var ratio = parseInt(wOriginal) / parseInt(w);
            $('#y_position').val(Math.round(Math.abs(ui.position.top * ratio)));
          }
        });

        $('#large_image').css('background-image','');

        $(".action-convert").show();
      }
      else{
        $('#large_image').css('background-image', current_bg);
        $("#image-priview").prepend('<div id="cropInstruction" style="text-align: center; background: gray; position: absolute; width: 100%;"><h2>image width for cover should be more than 1600px</h2></div>');
      }
    });
  }

  $(function(){
    $('#myTab4 a').click(function (e) {
      e.preventDefault();
      $(this).tab('show');
    });
  });

  $(".change-image").click(function(){
    $(".coverphoto").click();
  });

  $(".save-image").click(function(){
  $("#cropInstruction").remove();
    $('.drag-instructions').remove();
    $(".change-image").text("loading");
    $(this).text("loading");
    var fpfile = { url: $("#url_image").val(), mimetype: 'image/jpeg', isWriteable: true };
    var newImage = new Image();
    newImage.src = $("#url_image").val();
    console.log("Converting...");
    filepicker.convert(fpfile,
      {crop: [0, $("#y_position").val(), newImage.width, newImage.height]},
      {},
      function(new_FPFile){
        $(".save-image").text('reset');
        $(".change-image").text("reset");
        console.log(new_FPFile.url);
        $(".coverphoto, .funding-info").show();
        $('.ui-draggable').remove();
        $(".action-convert").hide();
        $("#cover-priview").remove();
        $('#large_image').css('background-image','url(' + new_FPFile.url + ')').css('-webkit-background-size', 'cover').css('-moz-background-size', 'cover').css('background-size', 'cover');
        $('#large_image').attr('data-image', 'true')
        $.ajax({
            url: '/projects/save_image',
            method: 'POST',
            data: { large_image: new_FPFile.url }
          });
        $("#image-priview").show();
        $(".save-image").text('Save Images');
        $(".change-image").text("Change cover photo");
      },
      function(FPError){
        console.log(FPError);
        $(".save-image").text('Save Images');
        $(".change-image").text("Change cover photo");
      }
    );
  });

  var userLocation = 'http://maps.googleapis.com/maps/api/geocode/json?address=#{@project.address},#{@project.city},#{@project.state}&sensor=false';

  $.ajax({
    url: userLocation,
    success: function(data) {
      console.log(data.results[0].geometry.location.lat);
      var latitude = data.results[0].geometry.location.lat;
      var longitude = data.results[0].geometry.location.lng;
      var map = L.map('map', {
        scrollWheelZoom: false
      }).setView([latitude,longitude], 11);

      var uruutIcon = L.icon({
        iconUrl: '#{image_path("map-icon.png")}',
        iconSize:     [36, 52]
      });

      L.tileLayer('http://{s}.tile.stamen.com/toner-lite/{z}/{x}/{y}.png', {
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>'
      }).addTo(map);

      L.marker([latitude,longitude], {icon:uruutIcon}).addTo(map)
    }
  });
